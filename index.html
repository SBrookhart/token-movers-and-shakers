
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Token Movers â€” Microcaps & Majors</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<!-- v2026-01-16E: Force spark=1 + fallback em-dash in 7d column; Token-first + URL column -->
<meta name="description" content="Daily token movers: gainers/losers across microcaps (<$50M) & majors (Topâ€‘100), with categories, 7â€‘day sparklines, and column headers. Served via a Cloudflare Worker." />
<style>
  :root {
    --bg:#0b0f14; --card:#111827; --border:#1f2937; --text:#e5e7eb; --muted:#94a3b8;
    --green:#22c55e; --red:#ef4444; --accent:#243041; --tab:#0f1620;
    --chip:#0e1724; --chip-ok:#113e22; --chip-err:#5a1313;
  }
  *{box-sizing:border-box}
  body{background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;padding:22px;}
  h1{text-align:center;margin:0 0 6px;}
  .meta{text-align:center;color:var(--muted);margin-bottom:12px;}
  .topbar{max-width:1100px;margin:0 auto 12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center;}
  .topbar input,.topbar select{background:#0f1620;color:#e5e7eb;border:1px solid #1f2937;border-radius:8px;padding:6px 10px;}
  .tabs{max-width:1100px;margin:0 auto 10px;display:flex;gap:8px;}
  .tab{background:var(--tab);border:1px solid var(--border);color:#cbd5e1;padding:8px 12px;border-radius:10px;cursor:pointer;}
  .tab.active{background:#1a2230;color:#fff;border-color:#2b3a51;}
  .panel{display:none}.panel.active{display:block}
  .two{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px;}
  .card{background:var(--card);border:1px solid var(--border);padding:12px;border-radius:12px;}
  .card h3{margin:4px 0 10px;display:flex;align-items:center;gap:10px;}
  .chip{font-size:.75rem;background:var(--chip);border:1px solid #22324a;color:#cbd5e1;padding:2px 8px;border-radius:999px;}
  .chip.ok{background:var(--chip-ok);border-color:#1d6830;color:#d1fae5}
  .list{display:grid;gap:6px;}

  /* Data rows: 6 columns = Token | Price | Market Cap | 24h % | 7d | URL */
  .row{
    display:grid;
    grid-template-columns: 1.35fr 100px 120px 90px 90px 1fr;
    gap:8px;align-items:center;padding:8px;
    border:1px solid #1f2937;border-radius:8px;background:#0f1620;
  }
  /* Token cell */
  .tokenCell{display:flex;align-items:center;gap:8px;min-width:0}
  .tokenCell a{color:#e5e7eb;text-decoration:none;display:inline-flex;align-items:center;gap:8px;min-width:0}
  .tokenCell a:hover{text-decoration:underline}
  .tokenCell img{width:20px;height:20px;border-radius:50%;}
  .nameText{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:48vw}
  .sym{color:#9ca3af;font-size:.9rem}

  .chg{font-weight:600;text-align:right}
  .sparkCell{display:flex;align-items:center;justify-content:flex-start;color:var(--muted)}
  canvas.spark{width:90px;height:24px}

  /* URL column */
  .urlCell{display:flex;align-items:center;gap:8px;min-width:0;justify-content:flex-start}
  .urlCell a{color:#93c5fd;text-decoration:underline;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:40vw}
  .ext{opacity:.8}

  /* Column headers: align to .row grid (6 columns) */
  .hdrrow{
    display:grid;
    grid-template-columns: 1.35fr 100px 120px 90px 90px 1fr;
    gap:8px;align-items:center;
    padding:6px 8px;margin:4px 0 8px 0;
    color:#cbd5e1;font-size:12px;text-transform:uppercase;letter-spacing:.03em;
    background:#0f1620;border:1px solid #1f2937;border-radius:8px;
  }
  .hdrrow > div{opacity:.9}

  details{background:#0f1620;border:1px solid var(--border);border-radius:10px;padding:10px 12px;max-width:1100px;margin:14px auto;}
  details summary{cursor:pointer;font-weight:600}
  .muted{color:#94a3b8}
  .footer{max-width:1100px;margin:18px auto 0;color:#9ca3af;font-size:12px;display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
  .footer a{color:#93c5fd;text-decoration:underline}

  .debug{max-width:1100px;margin:14px auto;background:#0f1620;border:1px solid #1f2937;border-radius:10px;padding:8px 12px;}
  .log{white-space:pre-wrap;font-family:ui-monospace, Menlo, Consolas, monospace;font-size:12px;color:#cbd5e1;max-height:220px;overflow:auto;background:#0b1119;border:1px solid #1f2937;border-radius:8px;padding:8px;}

  @media (max-width: 1120px){
    .nameText{max-width:40vw}
    .urlCell a{max-width:32vw}
  }
  @media (max-width: 900px){
    .row   { grid-template-columns: 1.35fr 100px 110px 90px 70px 1fr; }
    .hdrrow{ grid-template-columns: 1.35fr 100px 110px 90px 70px 1fr; }
    .urlCell a{max-width:28vw}
  }
  @media (max-width: 760px){
    .row   { grid-template-columns: 1.35fr 90px 100px 80px 60px 1fr; }
    .hdrrow{ grid-template-columns: 1.35fr 90px 100px 80px 60px 1fr; }
    .two{grid-template-columns:1fr}
    .nameText{max-width:52vw}
    .urlCell a{max-width:36vw}
  }
</style>
</head>
<body>
  <h1>ðŸ“ˆ Token Movers â€” Microcaps & Majors</h1>
  <div class="meta">
    <span id="updated">Loadingâ€¦</span> Â· Autoâ€‘refresh every 60s Â· <button id="refreshBtn">Refresh</button>
  </div>

  <!-- Topbar -->
  <div class="topbar">
    <input id="search" type="text" placeholder="Search name or symbolâ€¦" />
    <label for="cat">Category:</label>
    <select id="cat" title="CoinGecko categories">
      <option value="all" selected>All</option>
      <option value="ai-big-data">AI & Big Data</option>
      <option value="decentralized-finance-defi">DeFi</option>
      <option value="meme-token">Meme</option>
    </select>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" data-tab="micro">Microcaps (&lt;$50M)</div>
    <div class="tab" data-tab="majors">Major Players (Topâ€‘100)</div>
  </div>

  <!-- Microcaps panel -->
  <div id="panel-micro" class="panel active">
    <div class="two">
      <div class="card">
        <h3>Top 15 Gainers (24h) <span id="micro-src1" class="chip">loadingâ€¦</span></h3>
        <div class="hdrrow" role="row" aria-label="Columns: token, price, market cap, 24h change, 7d, url">
          <div>Token</div><div>Price</div><div>Market Cap</div><div>24h %</div><div>7d</div><div>URL</div>
        </div>
        <div id="micro-gainers" class="list"></div>
      </div>
      <div class="card">
        <h3>Top 15 Losers (24h) <span id="micro-src2" class="chip">loadingâ€¦</span></h3>
        <div class="hdrrow" role="row" aria-label="Columns: token, price, market cap, 24h change, 7d, url">
          <div>Token</div><div>Price</div><div>Market Cap</div><div>24h %</div><div>7d</div><div>URL</div>
        </div>
        <div id="micro-losers" class="list"></div>
      </div>
    </div>
  </div>

  <!-- Majors panel -->
  <div id="panel-majors" class="panel">
    <div class="two">
      <div class="card">
        <h3>Top 15 Gainers (24h) <span id="majors-src1" class="chip">loadingâ€¦</span></h3>
        <div class="hdrrow" role="row" aria-label="Columns: token, price, market cap, 24h change, 7d, url">
          <div>Token</div><div>Price</div><div>Market Cap</div><div>24h %</div><div>7d</div><div>URL</div>
        </div>
        <div id="majors-gainers" class="list"></div>
      </div>
      <div class="card">
        <h3>Top 15 Losers (24h) <span id="majors-src2" class="chip">loadingâ€¦</span></h3>
        <div class="hdrrow" role="row" aria-label="Columns: token, price, market cap, 24h change, 7d, url">
          <div>Token</div><div>Price</div><div>Market Cap</div><div>24h %</div><div>7d</div><div>URL</div>
        </div>
        <div id="majors-losers" class="list"></div>
      </div>
    </div>
  </div>

  <details open>
    <summary>ðŸ“š Methodology & Notes</summary>
    <div class="muted" style="margin-top:8px;line-height:1.5">
      <ul>
        <li><strong>Segments:</strong> Microcaps = cap &lt; $50M; Majors = Topâ€‘100 by market cap.</li>
        <li><strong>Category & Sparklines:</strong> Category filter and 7â€‘day series come from CoinGeckoâ€™s <code>/coins/markets</code> when requested via the Worker (<code>?category=â€¦&spark=1</code>).</li>
        <li><strong>Refresh & cache:</strong> Page refreshes every 60s; the Cloudflare Worker caches responses ~60s at the edge.</li>
      </ul>
    </div>
  </details>

  <details class="debug"><summary>ðŸ›  Debug</summary><pre id="debugLog" class="log">No logs yet.</pre></details>

  <div class="footer">
    <div>
      Data via
      https://api.coincap.ioCoinCap</a>,
      https://api.coinpaprika.comCoinPaprika</a>,
      https://www.coingecko.com/en/apiCoinGecko</a>.
    </div>
    <div id="teamSig">Â© 2026 <strong>Brookhart Labs</strong></div>
  </div>

<script>
/* ====== CONFIG ====== */
const WORKER_BASE = 'https://movers-proxy.sabina-brookhart.workers.dev';

/* ====== Debug logger ====== */
const LOG=document.getElementById('debugLog');
function dlog(...a){ LOG.textContent += `\n${new Date().toLocaleTimeString()}  ${a.map(x=>typeof x==='object'?JSON.stringify(x):String(x)).join(' ')}`; LOG.scrollTop=LOG.scrollHeight; }

/* ====== Tabs ====== */
document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.panel').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    document.getElementById('panel-'+t.dataset.tab).classList.add('active');
  });
});

/* ====== Search & Category ====== */
const searchInput=document.getElementById('search');
const catSelect=document.getElementById('cat');

/* ====== Helpers ====== */
function fmtUSD(x){ if(x==null) return 'â€”'; const n=Number(x); return n>=1? '$'+n.toLocaleString(undefined,{maximumFractionDigits:2}) : '$'+n.toFixed(6); }
function fmtCap(x){ if(x==null) return 'â€”'; const n=Number(x); if(n>=1e9) return '$'+(n/1e9).toFixed(2)+'B'; if(n>=1e6) return '$'+(n/1e6).toFixed(2)+'M'; return '$'+Math.round(n).toLocaleString(); }
function byDesc(a,b){ return (b.pct24??-Infinity)-(a.pct24??-Infinity); }
function byAsc(a,b){ return (a.pct24??Infinity)-(b.pct24??Infinity); }
function esc(s){ return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

/* Short, human-friendly URL label from href */
function prettyURLLabel(href){
  try{
    const u=new URL(href);
    const host=u.hostname.replace(/^www\./,'');
    let path=u.pathname.replace(/\/$/,'');
    if(path.length>24) path=path.slice(0,21)+'â€¦';
    return host + (path && path!=='/' ? path : '');
  }catch(_){ return href; }
}

/* ====== Tiny sparkline (90x24) ====== */
function drawSpark(canvas, arr, isUp){
  if(!canvas || !Array.isArray(arr) || arr.length<8){ return; }
  const w=canvas.width=90, h=canvas.height=24, min=Math.min(...arr), max=Math.max(...arr), span=(max-min)||1;
  const y=v=>h-((v-min)/span)*h; const ctx=canvas.getContext('2d'); ctx.clearRect(0,0,w,h);
  ctx.strokeStyle=isUp?'#22c55e':'#ef4444'; ctx.lineWidth=1.5; ctx.beginPath();
  for(let i=0;i<arr.length;i++){ const xx=(i/(arr.length-1))*w, yy=y(arr[i]); i?ctx.lineTo(xx,yy):ctx.moveTo(xx,yy); }
  ctx.stroke();
}

/* ====== Row rendering (Token first; URL separate) ====== */
function rowHTML(c){
  const up=(c.pct24??0)>=0;
  const img = c.img ? `${esc(c.img)}` : '<span>ðŸª™</span>';

  // Extract href from c.link (already an <a ...>..</a> string)
  const hrefMatch = (c.link||'').match(/href="([^"]+)"/i);
  const href = hrefMatch ? hrefMatch[1] : '#';
  const shortLabel = prettyURLLabel(href);

  // 7d content: canvas if spark exists, otherwise em-dash
  const sparkCell = Array.isArray(c.spark)
    ? '<canvas class="spark" width="90" height="24"></canvas>'
    : '<div class="sparkCell">â€”</div>';

  return `
    <div class="row">
      <!-- Token column (clickable): icon + name + symbol -->
      <div class="tokenCell">
        ${esc(href)}
          ${img}
          <span class="nameText">${esc(c.name)}</span>
          <span class="sym">${esc(c.symbol)}</span>
        </a>
      </div>

      <!-- Price -->
      <div>${fmtUSD(c.price)}</div>

      <!-- Market Cap -->
      <div>${fmtCap(c.cap)}</div>

      <!-- 24h % -->
      <div class="chg ${up?'pos':'neg'}">${(c.pct24??0).toFixed(2)}%</div>

      <!-- 7d sparkline (canvas or fallback em-dash) -->
      ${sparkCell}

      <!-- URL column -->
      <div class="urlCell">
        ${esc(href)}${esc(shortLabel)}</a>
        <span class="ext">ðŸ”—</span>
      </div>
    </div>`;
}

/* ====== Renderers ====== */
function renderList(id, rows){
  const q=(searchInput.value||'').trim().toLowerCase();
  const f=q? rows.filter(x=>x.name.toLowerCase().includes(q)||x.symbol.toLowerCase().includes(q)) : rows;
  const root=document.getElementById(id);
  root.innerHTML=f.map(rowHTML).join('');

  // draw sparklines where present
  const canvases=root.querySelectorAll('canvas.spark');
  let k=0;
  f.forEach((c)=>{
    if(Array.isArray(c.spark)){
      drawSpark(canvases[k], c.spark, (c.pct24??0)>=0);
      k++;
    }
  });
}
function renderAll(d){
  renderList('micro-gainers', d.microGainers || [...d.micro].sort(byDesc).slice(0,15));
  renderList('micro-losers',  d.microLosers  || [...d.micro].sort(byAsc).slice(0,15));
  renderList('majors-gainers', d.majorsGainers || [...d.majors].sort(byDesc).slice(0,15));
  renderList('majors-losers',  d.majorsLosers  || [...d.majors].sort(byAsc).slice(0,15));
}

/* ====== Fetch from Worker (now always requesting spark=1) ====== */
async function initLoad(){
  document.getElementById('updated').textContent='Loadingâ€¦';
  const cat = (catSelect.value || 'all');
  const params = `category=${encodeURIComponent(cat)}&spark=1`; // <â€” always ask for 7d series
  try{
    const [maj, mic] = await Promise.all([
      fetch(`${WORKER_BASE}/movers/majors?${params}`).then(r=>r.json()),
      fetch(`${WORKER_BASE}/movers/micro?${params}`).then(r=>r.json())
    ]);

    const cache = {
      majors: maj.items || [], micro: mic.items || [],
      majorsGainers: maj.gainers || null, majorsLosers: maj.losers || null,
      microGainers: mic.gainers || null,  microLosers: mic.losers  || null
    };
    renderAll(cache);

    // label chips
    ['micro-src1','micro-src2','majors-src1','majors-src2'].forEach(id=>{
      const el=document.getElementById(id); if(el){ el.textContent='Worker'; el.classList.add('chip','ok'); }
    });

    document.getElementById('updated').textContent='Last updated: '+new Date().toLocaleTimeString();
  } catch(e){
    dlog('UI error:', e.message||e);
    document.getElementById('updated').textContent='Error (see Debug)';
  }
}

/* Init */
document.getElementById('refreshBtn').onclick=initLoad;
initLoad(); setInterval(initLoad, 60_000);
</script>
</body>
</html>
